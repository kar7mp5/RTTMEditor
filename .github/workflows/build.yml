name: Build Executables

on:
    push:
        tags:
            - "v*"

jobs:
    build:
        strategy:
            matrix:
                os: [windows-latest, ubuntu-latest]
        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                  python-version: 3.10

            - name: Install dependencies
              run: pip install -r requirements.txt pyinstaller

            - name: Build Windows EXE
              if: matrix.os == 'windows-latest'
              run: pyinstaller --onefile --noconsole --name rttm_editor run.py

            - name: Build Linux ELF
              if: matrix.os == 'ubuntu-latest'
              run: pyinstaller --onefile --name rttm_editor run.py

            - name: Upload Windows EXE
              if: matrix.os == 'windows-latest'
              uses: actions/upload-artifact@v3
              with:
                  name: rttm_editor_windows
                  path: dist/rttm_editor.exe

            - name: Upload Linux ELF
              if: matrix.os == 'ubuntu-latest'
              uses: actions/upload-artifact@v3
              with:
                  name: rttm_editor_linux
                  path: dist/rttm_editor

    release:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Download Windows EXE
              uses: actions/download-artifact@v3
              with:
                  name: rttm_editor_windows
                  path: dist/

            - name: Download Linux ELF
              uses: actions/download-artifact@v3
              with:
                  name: rttm_editor_linux
                  path: dist/

            - name: Upload to GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: dist/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
